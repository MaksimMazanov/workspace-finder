# Техническая документация Workspace Finder

## 1. Назначение и область
Проект предоставляет веб‑приложение для поиска и просмотра рабочих мест, а также админ‑панель для импорта данных рабочих мест из XLS/XLSX.

## 2. Архитектура высокого уровня
**Frontend (SPA)**
- React 18 + TypeScript.
- UI библиотека: Chakra UI v3.
- Роутинг: react-router-dom.
- Клиент API: `src/api/workspaceApi.ts`.

**Backend (stub API)**
- Express (Node.js) в `stubs/api/index.js`.
- Парсер файлов: `xlsx`.
- Загрузка файлов: `multer`.
- Аутентификация: JWT + cookie `wf_admin_session`.

**Хранилище**
- MongoDB (если доступно).
- Fallback: in‑memory коллекции при отсутствии MongoDB.

**Dev/Build**
- @brojs/cli: `brojs server`, `brojs build`, `brojs compile`.

## 3. Технологии и зависимости
**Frontend**
- `react`, `react-dom`
- `react-router-dom`
- `@chakra-ui/react`
- `@emotion/react`
- `typescript`

**Backend**
- `express`
- `mongodb`
- `multer`
- `xlsx`
- `jsonwebtoken`
- `bcryptjs`

**Сборка/инструменты**
- `@brojs/cli`
- `eslint`

## 4. Структура проекта
```
src/
  api/                  # API клиент
  components/           # UI компоненты
  pages/                # Страницы
  hooks/                # Хуки
  utils/                # Утилиты/форматирование
stubs/
  api/                  # Express API
tasks/                  # ТЗ/описания задач
```

Ключевые файлы:
- `src/app.tsx` — корневое приложение, маршрутизация.
- `src/dashboard.tsx` — конфигурация роутов.
- `src/pages/main/main.tsx` — основная страница.
- `src/pages/login/login.tsx` — логин.
- `src/pages/admin/admin.tsx` — админ‑панель.
- `src/api/workspaceApi.ts` — клиент API.
- `stubs/api/index.js` — сервер, импорт, поиск, статистика.

## 5. Маршрутизация (Frontend)
- `/login` — вход пользователя.
- `/register` — регистрация пользователя.
- `/admin/login` — вход администратора.
- `/admin` — панель администратора.
- `/` — основная страница (поиск/карта/статистика/коворкинги).

## 6. API (stub backend)
Базовый путь: `/api`.

### 6.1. Аутентификация
**POST** `/api/auth/login`  
Вход пользователя по email/паролю.

**POST** `/api/auth/register`  
Регистрация нового пользователя.

**POST** `/api/auth/admin/login`  
Вход администратора по паролю, выдаёт cookie `wf_admin_session`.

**POST** `/api/auth/logout`  
Сброс админ‑сессии.

**GET** `/api/auth/me`  
Проверка текущего пользователя.

**GET** `/api/auth/admin/me`  
Проверка роли администратора.

### 6.2. Данные рабочих мест
**GET** `/api/search?q=...&status=...`  
Поиск по ФИО/номеру места.

**GET** `/api/workplaces?...`  
Список рабочих мест с группировкой по блокам.

**GET** `/api/coworkings`  
Список коворкингов.

**GET** `/api/zones`  
Список зон и рабочих мест по зонам.

**GET** `/api/stats`  
Агрегированная статистика.

### 6.3. Админ‑импорт
**POST** `/api/admin/upload`  
Загрузка XLS/XLSX (multipart). Перед импортом все данные очищаются.

**GET** `/api/admin/imports`  
История импортов.

## 7. Формат импорта (XLS/XLSX)
Поддерживается «Подробно» лист с полями:
- `Наименование РМ` — номер/код рабочего места.
- `Статус занятости РМ. Описание` — источник статуса.
- `Название подразделения Блок-1` — отдел (для UI маппинга).
- `ФИО сотрудника` / `ФИО ДП` / `ФИО ЛГ` — имя сотрудника/подрядчика.
- `Номер помещения`, `Ид. Помещения`, `Ид. РМ` — источники для `blockCode`.

Поведение:
- Перед импортом выполняется очистка данных.
- `blockCode` строится из `placeNumber` (если содержит блок) или из `Ид. Помещения/Номер помещения`.
- Если ФИО нет, отображается описание статуса (коворкинг/резерв/вакансия).

## 8. Нормализация и форматирование (UI)
Файл: `src/utils/formatters.ts`
- Нормализация меток сотрудника: `Coworking-*` → `Коворкинг`.
- Стилизация меток: коворкинг — зелёный, резерв — жирный, вакансия — серый жирный.
- Маппинг отделов к псевдонимам (таблица соответствий).

## 9. Сортировки в UI
- Блоки сортируются с приоритетом:
  1) `5.а.01`
  2) `5.а.02`
  3) `5.в.01`
  4) `5.в.02`
  затем остальные по алфавиту/числам.
- Места внутри блока сортируются по `placeNumber`.

## 10. Запуск и сборка
**Dev**
```
npm start
```
Запускает `brojs server` и stub API.

**Build**
```
npm run build
```

## 11. Аутентификация администратора
Пароль хранится в виде bcrypt‑хеша (`ADMIN_PASSWORD_HASH`) в окружении.
По умолчанию в stub используется предустановленный хеш.

## 12. Логи и диагностика импорта
Ответ `/api/admin/upload` включает:
- `total`, `inserted`, `updated`, `errors`
- `debug` (если есть ошибки): выбранный лист, строка заголовков, превью первых строк.

## 13. Известные ограничения
- Stub API предназначен для локальной разработки.
- MongoDB опциональна; при отсутствии — in‑memory.
- В UI статус поля скрыт, но используется для логики отображения.

