# Task: Авторизация и доступы (WorkspaceFinder)

Цель: сделать безопасную и понятную авторизацию для **MVP**, чтобы:
- обычные пользователи могли пользоваться поиском без лишней сложности,
- **админ-панель загрузки XLS** была защищена,
- были логи действий (аудит) и минимальная защита от злоупотреблений.

---

## 1) Требования (MVP)

### 1.1 Роли
- `user` — доступ к просмотру/поиску.
- `admin` — доступ к загрузке XLS и просмотру журнала импортов.

### 1.2 Принцип
- **Пользовательский “вход по имени”** не должен давать никаких прав и не должен считаться настоящей аутентификацией.
- Настоящая защита нужна **только** для `admin`-доступа.

### 1.3 Базовые ограничения безопасности
- Нельзя выполнять админ-операции без роли `admin`.
- Пароль админа не хранить в коде/репозитории.
- Лимитировать попытки входа (rate limit).
- Логировать все импорты и админ-входы.

---

## 2) Рекомендуемый вариант для MVP (самый простой и нормальный)

### Вариант A (рекомендую): Admin login по паролю + JWT/Session cookie
**Почему:** быстро, безопаснее “fixed password на фронте”, легко расширить до SSO позже.

**Как работает:**
1. На сервере есть env-переменная `ADMIN_PASSWORD_HASH` (bcrypt-хэш).
2. Админ вводит пароль на странице `/admin/login`.
3. Backend проверяет пароль и выдаёт **HTTP-only cookie** с токеном (JWT или session-id).
4. Все админ-эндпоинты защищены middleware `requireAdmin`.

---

## 3) API и контракты

### 3.1 Auth endpoints
#### `POST /api/auth/admin/login`
**Body**
```json
{ "password": "..." }
```

**Response (200)**
```json
{ "success": true, "role": "admin" }
```

**Side-effect:** установить cookie `wf_admin_session=...` (HttpOnly, Secure, SameSite).

**Ошибки**
- 401: неверный пароль
- 429: слишком много попыток

#### `POST /api/auth/logout`
Удаляет cookie.

#### `GET /api/auth/me`
Возвращает текущую роль.
```json
{ "success": true, "role": "admin" }
```
или
```json
{ "success": true, "role": "user" }
```

> Примечание: “user” может быть просто “по умолчанию” без токена.

---

## 4) Backend реализация (Node.js + Express + TypeScript)

### 4.1 ENV
- `ADMIN_PASSWORD_HASH` — bcrypt hash (генерируется один раз).
- `JWT_SECRET` — если используем JWT.
- `COOKIE_SECURE=true` в проде (HTTPS).
- `CORS_ORIGIN=https://your-frontend-domain`.

### 4.2 Middleware
- `requireAdmin(req,res,next)`
  - достаёт токен из cookie
  - валидирует токен
  - проверяет `role === "admin"`

### 4.3 Cookie настройки (важно)
- `HttpOnly: true` — JS не читает.
- `Secure: true` — только HTTPS (в проде обязательно).
- `SameSite: "Lax"` или `"Strict"` (если фронт и бэк на одном домене — лучше Strict; если разные — Lax + правильно настроенный CORS).
- `Path: "/"`

### 4.4 Защита от перебора пароля
- Rate limit на `/api/auth/admin/login`:
  - например 5 попыток / 15 минут на IP (или IP+UA).
- Логи не должны писать пароль.

### 4.5 Аудит (ImportLog + auth events)
Логировать:
- успешный и неуспешный вход админа (без пароля, только meta: ip, ua, time)
- каждую загрузку XLS: кто, когда, имя файла, сколько строк, список ошибок

---

## 5) Frontend реализация (React)

### 5.1 UX
- Обычная часть приложения доступна без реальной авторизации.
- Админка:
  - маршрут `/admin`
  - если `GET /api/auth/me` не admin → редирект на `/admin/login`
- На `/admin/login` форма ввода пароля.
- После логина — переход в `/admin`.

### 5.2 Без хранения пароля на фронте
- Пароль не сохранять в localStorage.
- Используем cookie-сессию.

---

## 6) Что НЕ делать (частые ошибки)
- ❌ Не хранить `ADMIN_PASSWORD` в фронтенде или в репозитории.
- ❌ Не делать “проверку пароля” на клиенте.
- ❌ Не использовать localStorage для токена админа (хуже при XSS).
- ❌ Не оставлять CORS “*” в проде.

---

## 7) Расширение после MVP (опционально)
Если есть корпоративная инфраструктура:
- SSO (OIDC/SAML) через Keycloak/ADFS/Okta/Azure AD
- Список админов по e-mail/группе
- Логи и права через RBAC (несколько ролей)

---

## 8) Acceptance Criteria
1. Без входа в админку запрос `POST /api/admin/upload` возвращает **401/403**.
2. С правильным паролем админ получает cookie и может загрузить XLS.
3. После `logout` доступ к админке снова закрыт.
4. Есть rate-limit на `/api/auth/admin/login`.
5. Все загрузки XLS создают запись ImportLog + audit meta (ip, ua, время).
6. Пароль нигде не отображается и не логируется.

---

## 9) Подзадачи (чеклист)
- [ ] Добавить `POST /api/auth/admin/login`, `POST /api/auth/logout`, `GET /api/auth/me`
- [ ] Добавить `requireAdmin` middleware
- [ ] Настроить cookie + CORS
- [ ] Добавить rate limiter на admin login
- [ ] Обновить админ-роуты: защищать `POST /api/admin/upload`
- [ ] Реализовать `/admin/login` на фронте
- [ ] Реализовать guard для `/admin`
- [ ] Добавить audit-логирование
- [ ] Протестировать сценарии (AC из секции 8)

---

## 10) Пример команд для генерации bcrypt hash (локально)
> Выполняется один раз на машине разработчика, результат кладём в ENV.

```bash
node -e "const bcrypt=require('bcryptjs'); bcrypt.hash('YOUR_ADMIN_PASSWORD', 12).then(console.log)"
```

---

Если нужно — могу следующим шагом накидать готовые куски кода для Express middleware + endpoints и пример React guard.
